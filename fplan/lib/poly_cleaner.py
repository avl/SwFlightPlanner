from pyshapemerge2d import Vertex,Line,Polygon,vvector,tidy_up_polygon
import fplan.lib.mapper as mapper
from itertools import izip,chain
import math

def clean_up_polygon(poss):
    print "Clean poly:",poss
    def tov(merc):
        return Vertex(int(merc[0]),int(merc[1]))
    def fromv(v):
        return (v.get_x(),v.get_y())
    vertices=[]
    last=None
    for pos in poss:
        #print pos
        if pos==last: continue
        last=pos
        vertices.append(tov(mapper.latlon2merc(mapper.from_str(pos),13)))
    poly=Polygon(vvector(vertices))
    #print "calling tidy-up"
    shape=tidy_up_polygon(poly)
    ret=[]
    for poly in shape.get_polys():
        #print "Got poly"
        vs=poly.get_vertices()
        out=[]
        for v in vs:
            out.append(mapper.to_str(mapper.merc2latlon(fromv(v),13)))
        ret.append(out)
    return ret
def test_clean_up():
    x=['69.0600000000,20.5486111111', '69.057730,20.550098', '69.060303,20.580929', '69.053055,20.604164', '69.043793,20.650063', '69.031097,20.744164', '69.023331,20.791664', '69.011932,20.846386', '69.004990,20.866665', '68.997498,20.884441', '68.985550,20.908886', '68.973053,20.928608', '68.968323,20.932777', '68.958328,20.938889', '68.952774,20.938332', '68.946381,20.931110', '68.939438,20.915554', '68.925827,20.888885', '68.913330,20.883053', '68.907776,20.882774', '68.898041,20.888611', '68.893600,20.895275', '68.889999,20.904163', '68.886658,20.915276', '68.881378,20.944721', '68.879990,20.959442', '68.879440,20.990833', '68.877487,21.024719', '68.873322,21.058887', '68.866653,21.081387', '68.819717,21.207775', '68.816101,21.216663', '68.724152,21.420555', '68.691101,21.448608', '68.686661,21.452774', '68.678055,21.465553', '68.671387,21.487499', '68.668320,21.500832', '68.661652,21.550552', '68.658600,21.585278', '68.656097,21.601109', '68.649429,21.623055', '68.642487,21.642776', '68.620819,21.701664', '68.617218,21.710278', '68.612488,21.714165', '68.606384,21.711109', '68.600555,21.710552', '68.591110,21.718330', '68.583603,21.735554', '68.576935,21.757500', '68.574432,21.773331', '68.570541,21.809166', '68.570267,21.824718', '68.573608,21.864719', '68.572495,21.881386', '68.569992,21.897221', '68.555267,21.933887', '68.543884,21.959442', '68.531276,21.983299', '68.2958333333,21.7700000000', '67.7900000000,21.2702777778', '67.7900000000,20.9119444444', '67.9900000000,20.8119444444', '68.3558333333,19.9211111111', '68.340991,19.900703', '68.336655,19.923885', '68.337494,19.937775', '68.340820,19.948055', '68.344711,19.956665', '68.349716,19.964165', '68.361374,19.976665', '68.381104,20.006664', '68.394989,20.030277', '68.403320,20.048054', '68.414719,20.075832', '68.443878,20.167221', '68.448044,20.175831', '68.462769,20.198608', '68.475830,20.208611', '68.482208,20.211109', '68.501663,20.088055', '68.543884,19.956387', '68.583054,20.063053', '68.646942,20.177219', '68.662216,20.202499', '68.691376,20.238331', '68.754715,20.313889', '68.786652,20.350277', '68.928329,20.314720', '68.968597,20.238888', '69.042221,20.096943', '69.056381,20.535275', '69.057730,20.550098']
    
    for idx,cleaned in enumerate(clean_up_polygon(x)):
        print "#%d:"%(idx,)," - ".join(cleaned)
    
if __name__=='__main__':
    test_clean_up()
    
